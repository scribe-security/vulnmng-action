name: Test vulnmng Action

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-action:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Build Base Image
        run: |
          TAG="latest"
          if [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            TAG="dev-latest"
          fi
          echo "Building with tag: $TAG"
          docker build -t ghcr.io/scribe-security/vulnmng:$TAG .
          # For local action testing within this workflow, we might also need a consistent local tag
          docker tag ghcr.io/scribe-security/vulnmng:$TAG ghcr.io/scribe-security/vulnmng:latest

      - name: Create Test Package with Known Vulnerabilities
        run: |
          cat > package-lock.json << 'EOF'
          {
            "name": "test-vulnerable-app",
            "version": "1.0.0",
            "lockfileVersion": 3,
            "requires": true,
            "packages": {
              "": {
                "name": "test-vulnerable-app",
                "version": "1.0.0",
                "dependencies": {
                  "axios": "0.21.1",
                  "lodash": "4.17.19",
                  "log4js": "6.3.0",
                  "minimist": "1.2.5"
                }
              },
              "node_modules/axios": {
                "version": "0.21.1",
                "resolved": "https://registry.npmjs.org/axios/-/axios-0.21.1.tgz",
                "integrity": "sha512-dKQiRHxGD9PPRIUNIWvZhPTPpl1rf/OxTYKsqKUDjBwYylTvV7SjSHJb9ratfyzM6wCdLCOYLzs73qpg5c4iGA==",
                "license": "MIT",
                "dependencies": {
                  "follow-redirects": "^1.10.0"
                }
              },
              "node_modules/date-format": {
                "version": "3.0.0",
                "resolved": "https://registry.npmjs.org/date-format/-/date-format-3.0.0.tgz",
                "integrity": "sha512-eyTcpKOcamdhWJXj56DpQMo1ylSQpcGtGKXcU0Tb97+K56/CF5amAqqqNj0+KvA0iw2ynxtHWFsPDSClCxe48w==",
                "deprecated": "3.x is no longer supported. Please upgrade to 4.x or higher.",
                "license": "MIT",
                "engines": {
                  "node": ">=4.0"
                }
              },
              "node_modules/debug": {
                "version": "4.4.3",
                "resolved": "https://registry.npmjs.org/debug/-/debug-4.4.3.tgz",
                "integrity": "sha512-RGwwWnwQvkVfavKVt22FGLw+xYSdzARwm0ru6DhTVA3umU5hZc28V3kO4stgYryrTlLpuvgI9GiijltAjNbcqA==",
                "license": "MIT",
                "dependencies": {
                  "ms": "^2.1.3"
                },
                "engines": {
                  "node": ">=6.0"
                },
                "peerDependenciesMeta": {
                  "supports-color": {
                    "optional": true
                  }
                }
              },
              "node_modules/flatted": {
                "version": "2.0.2",
                "resolved": "https://registry.npmjs.org/flatted/-/flatted-2.0.2.tgz",
                "integrity": "sha512-r5wGx7YeOwNWNlCA0wQ86zKyDLMQr+/RB8xy74M4hTphfmjlijTSSXGuH8rnvKZnfT9i+75zmd8jcKdMR4O6jA==",
                "license": "ISC"
              },
              "node_modules/follow-redirects": {
                "version": "1.15.11",
                "resolved": "https://registry.npmjs.org/follow-redirects/-/follow-redirects-1.15.11.tgz",
                "integrity": "sha512-deG2P0JfjrTxl50XGCDyfI97ZGVCxIpfKYmfyrQ54n5FO/0gfIES8C/Psl6kWVDolizcaaxZJnTS0QSMxvnsBQ==",
                "funding": [
                  {
                    "type": "individual",
                    "url": "https://github.com/sponsors/RubenVerborgh"
                  }
                ],
                "license": "MIT",
                "engines": {
                  "node": ">=4.0"
                },
                "peerDependenciesMeta": {
                  "debug": {
                    "optional": true
                  }
                }
              },
              "node_modules/fs-extra": {
                "version": "8.1.0",
                "resolved": "https://registry.npmjs.org/fs-extra/-/fs-extra-8.1.0.tgz",
                "integrity": "sha512-yhlQgA6mnOJUKOsRUFsgJdQCvkKhcz8tlZG5HBQfReYZy46OwLcY+Zia0mtdHsOo9y/hP+CxMN0TU9QxoOtG4g==",
                "license": "MIT",
                "dependencies": {
                  "graceful-fs": "^4.2.0",
                  "jsonfile": "^4.0.0",
                  "universalify": "^0.1.0"
                },
                "engines": {
                  "node": ">=6 <7 || >=8"
                }
              },
              "node_modules/graceful-fs": {
                "version": "4.2.11",
                "resolved": "https://registry.npmjs.org/graceful-fs/-/graceful-fs-4.2.11.tgz",
                "integrity": "sha512-RbJ5/jmFcNNCcDV5o9eTnBLJ/HszWV0P73bc+Ff4nS/rJj+YaS6IGyiOL0VoBYX+l1Wrl3k63h/KrH+nhJ0XvQ==",
                "license": "ISC"
              },
              "node_modules/jsonfile": {
                "version": "4.0.0",
                "resolved": "https://registry.npmjs.org/jsonfile/-/jsonfile-4.0.0.tgz",
                "integrity": "sha512-m6F1R3z8jjlf2imQHS2Qez5sjKWQzbuuhuJ/FKYFRZvPE3PuHcSMVZzfsLhGVOkfd20obL5SWEBew5ShlquNxg==",
                "license": "MIT",
                "optionalDependencies": {
                  "graceful-fs": "^4.1.6"
                }
              },
              "node_modules/lodash": {
                "version": "4.17.19",
                "resolved": "https://registry.npmjs.org/lodash/-/lodash-4.17.19.tgz",
                "integrity": "sha512-JNvd8XER9GQX0v2qJgsaN/mzFCNA5BRe/j8JN9d+tWyGLSodKQHKFicdwNYzWwI3wjRnaKPsGj1XkBjx/F96DQ==",
                "license": "MIT"
              },
              "node_modules/log4js": {
                "version": "6.3.0",
                "resolved": "https://registry.npmjs.org/log4js/-/log4js-6.3.0.tgz",
                "integrity": "sha512-Mc8jNuSFImQUIateBFwdOQcmC6Q5maU0VVvdC2R6XMb66/VnT+7WS4D/0EeNMZu1YODmJe5NIn2XftCzEocUgw==",
                "license": "Apache-2.0",
                "dependencies": {
                  "date-format": "^3.0.0",
                  "debug": "^4.1.1",
                  "flatted": "^2.0.1",
                  "rfdc": "^1.1.4",
                  "streamroller": "^2.2.4"
                },
                "engines": {
                  "node": ">=8.0"
                }
              },
              "node_modules/minimist": {
                "version": "1.2.5",
                "resolved": "https://registry.npmjs.org/minimist/-/minimist-1.2.5.tgz",
                "integrity": "sha512-FM9nNUYrRBAELZQT3xeZQ7fmMOBg6nWNmJKTcgsJeaLstP/UODVpGsr5OhXhhXg6f+qtJ8uiZ+PUxkDWcgIXLw==",
                "license": "MIT"
              },
              "node_modules/ms": {
                "version": "2.1.3",
                "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
                "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
                "license": "MIT"
              },
              "node_modules/rfdc": {
                "version": "1.4.1",
                "resolved": "https://registry.npmjs.org/rfdc/-/rfdc-1.4.1.tgz",
                "integrity": "sha512-q1b3N5QkRUWUl7iyylaaj3kOpIT0N2i9MqIEQXP73GVsN9cw3fdx8X63cEmWhJGi2PPCF23Ijp7ktmd39rawIA==",
                "license": "MIT"
              },
              "node_modules/streamroller": {
                "version": "2.2.4",
                "resolved": "https://registry.npmjs.org/streamroller/-/streamroller-2.2.4.tgz",
                "integrity": "sha512-OG79qm3AujAM9ImoqgWEY1xG4HX+Lw+yY6qZj9R1K2mhF5bEmQ849wvrb+4vt4jLMLzwXttJlQbOdPOQVRv7DQ==",
                "deprecated": "2.x is no longer supported. Please upgrade to 3.x or higher.",
                "license": "MIT",
                "dependencies": {
                  "date-format": "^2.1.0",
                  "debug": "^4.1.1",
                  "fs-extra": "^8.1.0"
                },
                "engines": {
                  "node": ">=8.0"
                }
              },
              "node_modules/streamroller/node_modules/date-format": {
                "version": "2.1.0",
                "resolved": "https://registry.npmjs.org/date-format/-/date-format-2.1.0.tgz",
                "integrity": "sha512-bYQuGLeFxhkxNOF3rcMtiZxvCBAquGzZm6oWA1oZ0g2THUzivaRhv8uOhdr19LmoobSOLoIAxeUK2RdbM8IFTA==",
                "deprecated": "2.x is no longer supported. Please upgrade to 4.x or higher.",
                "license": "MIT",
                "engines": {
                  "node": ">=4.0"
                }
              },
              "node_modules/universalify": {
                "version": "0.1.2",
                "resolved": "https://registry.npmjs.org/universalify/-/universalify-0.1.2.tgz",
                "integrity": "sha512-rBJeI5CXAlmy1pV+617WB9J63U6XcazHHF2f2dbJix4XzpUF0RS3Zbj0FGIOCAva5P/d/GBOYaACQ1w+0azUkg==",
                "license": "MIT",
                "engines": {
                  "node": ">= 4.0.0"
                }
              }
            }
          }
          EOF
          cat package-lock.json

      - name: Run Scan Action (Self-Test)
        uses: ./actions/vulnmng
        env:
          VULNMNG_DEBUG: 'true'
        with:
          command: 'scan'
          target: '.'
          target-name: 'monorepo-test'
          enrichment: 'cisa'
          # Verify git integration works in test
          git-root: '.'
          git-branch: 'test-issues'
          git-token: ${{ secrets.GITHUB_TOKEN }}
          # We don't fail here yet to ensure reports are generated
          fail-on: 'Critical'

      - name: Reset to Original Branch
        run: git checkout ${{ github.sha }}

      - name: Run Report Action
        uses: ./actions/vulnmng
        env:
          VULNMNG_DEBUG: 'true'
        with:
          command: 'report'
          enrichment: 'cisa'
          format-md: 'test-report.md'
          format-csv: 'test-report.csv'
          git-root: '.'
          git-branch: 'test-issues'
          git-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Reports
        run: |
          ls -l test-report.md test-report.csv issues.json
          grep "monorepo-test" issues.json
